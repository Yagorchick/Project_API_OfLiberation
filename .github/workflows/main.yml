name: .NET Build & Test

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master", "develop" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        lfs: false

    - name: Fix Contracts encoding specifically
      run: |
        # Исправляем только проблемные файлы в Contracts
        find ./src/Project/Contracts -name "*.cs" -type f | while read file; do
          echo "Processing $file"
          # Убираем BOM и невидимые символы
          sed -i '1s/^\xEF\xBB\xBF//' "$file"
          # Удаляем невидимые символы и нормализуем пробелы
          sed -i 's/[[:space:]]*$//' "$file"
          # Удаляем возможные нулевые байты
          tr -d '\000' < "$file" > "${file}.tmp" && mv "${file}.tmp" "$file"
        done
        
        # Дополнительно: показываем проблемные строки для диагностики
        echo "=== Checking problematic files ==="
        find ./src/Project/Contracts -name "*.cs" -type f | while read file; do
          if grep -q -P -n "[^\x00-\x7F]" "$file"; then
            echo "Non-ASCII characters in $file:"
            grep -P -n "[^\x00-\x7F]" "$file"
          fi
        done
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore "src/Project/Project.sln"

    - name: Build
      run: dotnet build "src/Project/Project.sln" --no-restore --configuration Release

    - name: Test
      run: dotnet test "src/Project/Project.sln" --no-build --verbosity normal --configuration Release
